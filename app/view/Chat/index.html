{include file="Common/top" title="首页" metas='' /}
{if condition="authority('Talk')"}
<style>
    .chat-input{
        height: 100px;
        width: 100%;
        resize: none;
        border: none;
        outline: none;
    }
    .toolbar{
        width: 100%;
        height: 30px;
        margin-top: 5px;
    }

    .toolbar ul{
        float: left;
        list-style: none;
        margin: 0;
        display: -webkit-box;
        -webkit-box-orient: horizontal;
    }

    .toolbar ul li{
        padding:5px;
    }

    .chat li .img{
        width: 100px;
        height: 100px;
        -webkit-border-radius: 0;
        padding-top: 5px;
    }
</style>
<script src="__PUBLIC__/js/multiple-select/multiple-select.js"></script>
<div class="main-container">
    <div class="padding-md">
        <ul class="breadcrumb">
            <li><span class="primary-font"><i class="icon-home"></i></span><a href="__PRO_PATH__/">首页</a></li>
            <li>在线互动</li>
        </ul>

        <div class="row" id="chat">
            <div class="col-lg-12">
                <div class="smart-widget widget-purple">
                    <div class="smart-widget-header">
                        <i class="fa fa-comment"></i> {{chat_to_user.name}}--{{item}}
                        <span class="smart-widget-option">
                            <span class="refresh-icon-animated">
                                <i class="fa fa-circle-o-notch fa-spin"></i>
                            </span>
                            <a href="#" class="widget-toggle-hidden-option">
                                <i class="fa fa-cog"></i>
                            </a>
                            <a href="#" class="widget-collapse-option" data-toggle="collapse">
					            <i class="fa fa-chevron-up"></i>
                            </a>
                            <a href="#" class="widget-refresh-option">
                                <i class="fa fa-refresh"></i>
                            </a>
                        </span>
                    </div>
                    <div class="smart-widget-inner">
                        <div class="smart-widget-hidden-section">
                            <ul class="widget-color-list clearfix">
                                <li style="background-color:#20232b;" data-color="widget-dark"></li>
                                <li style="background-color:#4c5f70;" data-color="widget-dark-blue"></li>
                                <li style="background-color:#23b7e5;" data-color="widget-blue"></li>
                                <li style="background-color:#2baab1;" data-color="widget-green"></li>
                                <li style="background-color:#edbc6c;" data-color="widget-yellow"></li>
                                <li style="background-color:#fbc852;" data-color="widget-orange"></li>
                                <li style="background-color:#e36159;" data-color="widget-red"></li>
                                <li style="background-color:#7266ba;" data-color="widget-purple"></li>
                                <li style="background-color:#f5f5f5;" data-color="widget-light-grey"></li>
                                <li style="background-color:#fff;" data-color="reset"></li>
                            </ul>
                        </div>
                        <div class="smart-widget-body">
                            <div id="chatScroll">
                                <ul class="chat">
                                    <template v-for="model in chat">
                                        <li :class="[model.source_user_id != vm3.user_id ? 'left' : 'right' ,'clearfix']">
                                        <span :class="['chat-img', model.source_user_id != vm3.user_id ? 'pull-left' : 'pull-right']">
                                            <img class="logo" :src="model.source_user_id != vm3.user_id ? chat_to_user.logo : chat_user.logo" :title="model.source_user_id != vm3.user_id ? chat_to_user.name : chat_user.name">
                                        </span>
                                            <div class="chat-body clearfix">
                                                <div class="header">
                                                    <strong :class="['primary-font', model.source_user_id != vm3.user_id ? 'pull-left' : 'pull-right']">{{model.source_user_id != vm3.user_id ? chat_to_user.name : chat_user.name}}</strong>
                                                    <!--<small class="pull-right text-muted">-->
                                                    <!--<i class="fa fa-clock-o"></i>-->
                                                    <!--12 mins ago-->
                                                    <!--</small>-->
                                                </div>
                                                <!-- 1 - text -->
                                                <template v-if="model.type == 1">
                                                    <p :class="['chat-img', model.source_user_id != vm3.user_id ? 'pull-left' : 'pull-right']">
                                                        {{model.content}}
                                                    </p>
                                                </template>
                                                <!-- 2 - image -->
                                                <template v-if="model.type == 2">
                                                    <img class="img" :src="model.content">
                                                </template>

                                            </div>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                        <div class="smart-widget-footer">
                            <div class="col-lg-12 toolbar">
                                <ul>
                                    <li><i class="fa fa-file-o fa-lg" aria-hidden="true"></i></li>
                                    <li><i class="fa fa-file-o fa-lg" aria-hidden="true"></i></li>
                                    <li><i class="fa fa-file-o fa-lg" aria-hidden="true"></i></li>
                                    <li><i class="fa fa-file-o fa-lg" aria-hidden="true"></i></li>
                                    <li><i class="fa fa-file-o fa-lg" aria-hidden="true"></i></li>
                                    <li><i class="fa fa-file-o fa-lg" aria-hidden="true"></i></li>
                                </ul>
                            </div>
                            <div class="input-group">
                                <textarea id="btn-input" class="col-lg-12 chat-input" placeholder="请输入消息···" @keyup.13="enter($event)" v-model="content"></textarea>
                                <span class="input-group-btn">
                                    <button class="btn btn-success btn-sm no-shadow" id="btn-chat" style="height: 100px;">发送</button>
                                </span>
                            </div><!-- /input-group -->
                        </div><!-- ./smart-widget-footer -->
                    </div><!-- ./smart-widget-inner -->
                </div><!-- ./smart-widget -->
            </div><!-- ./col -->
        </div>

    </div><!-- ./row -->
</div><!-- /main-container -->
{include file="Common/bottom" /}
{include file="Common/calendar" /}
{include file="Common/popup_warn" /}
{include file="Common/popup_list" /}
{include file="Common/calendar" /}
{include file="Common/upload" /}
<!-- Slimscroll -->
<script src='__PUBLIC__/js/jquery.slimscroll.min.js'></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/js/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/js/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/js/ueditor/lang/zh-cn/zh-cn.js"></script>
<script>
    $('#consultation-nav-chat').addClass('active');

    var vm = new Vue({
        el: '#chat',
        data: {
            to_send: false,
            params: {
                target_user_id: '{$target_user_id}',
                source_user_id: '{$account.id}',
                type: '',
                content: '',
                content_origin: '',
                status: 0
            },
            receive_params:{
                target_user_id: '{$target_user_id}',
                source_user_id: '{$account.id}',
                total: 0,
                per_page: 20,
                current_page: 1,
                pages: 1
            },
            item: '讨论4号病患的病情',
            content: '',
            chat_to_user: {
                id: '{$target_user_id}',
                logo: '__PUBLIC__/images/profile/profile1.jpg',
                name: 'Jeremy'
            },
            chat_user: {
                id: vm3.user_id,
                logo: '__PUBLIC__/images/profile/profile2.jpg',
                name: 'Smith'
            },
            seen:{
            },

            errors:{

            },
            chat: [],

            receiveIds: [],

            readIds: []
        },
        mounted:function () {
            // comet实现
//            $(function () {
//                (function longPolling() {
//                    $.ajax({
//                        type:"POST",
//                        url: "__PRO_PATH__/Chat/receive",
//                        data: {
//                            request_time: Date.parse(new Date()) / 1000,
//                            target_user_id: '{$target_user_id}',
//                            source_user_id: '{$account.id}'
//                        },
//                        dataType: "json",
//                        timeout: 2000, //5秒超时，可自定义设置
//                        error: function (XMLHttpRequest, textStatus, errorThrown) {
//                            if (textStatus == "timeout") { // 请求超时
//                                longPolling(); // 递归调用
//                            } else { // 其他错误，如网络错误等
//                                longPolling();
//                            }
//                        },
//                        success: function (res) {
//                            console.log(JSON.stringify(res));
//                            if (res.error_code == 0) { // 请求成功
//                                if (res.data.length != 0) {
//                                    vm.receiveMsg(res.data);
//                                }
//                            }
//                            longPolling();
//                        }
//                    });
//                })();
//            });

            //Scrollable Chat Widget
            $('#chatScroll').slimScroll({
                height:'300px',
                start: 'bottom'
            });

            $('#btn-chat').click(function () {
                if(vm.check()){
                    vm.send();
                }
            });

            myupload({
                container: 'upload-wrapper',
                browse: 'pickfiles',
                url: '__PRO_PATH__/Media/upload?dir=import',
                img_types: 'jpg,gif,png',
                zip_types: 'zip',
                filelist: 'filelist',
                uploadfiles: 'uploadfiles',
                file_size: '10mb',
                onUploaded: function (up, file, result) {
                    $("input[name='files_path_origin']").val(file.name);
                    var res = JSON.parse(result.response);
                    $("input[name='files_path']").val(res.result.file);
                },
                isMulti: false
            });
            myupload({
                container: 'upload_left_eye',
                browse: 'pickfiles_left_eye',
                url: '__PRO_PATH__/Media/upload?dir=import',
                img_types: 'jpg,gif,png',
                zip_types: 'zip',
                filelist: 'filelist_left_eye',
                uploadfiles: 'uploadfiles_left_eye',
                file_size: '10mb',
                onUploaded: function (up, file, result) {
                    $("input[name='eye_photo_left_origin']").val(file.name);
                    var res = JSON.parse(result.response);
                    $("input[name='eye_photo_left']").val(res.result.file);
                },
                isMulti: false
            });
            myupload({
                container: 'upload_right_eye',
                browse: 'pickfiles_right_eye',
                url: '__PRO_PATH__/Media/upload?dir=import',
                img_types: 'jpg,gif,png',
                zip_types: 'zip',
                filelist: 'filelist_right_eye',
                uploadfiles: 'uploadfiles_right_eye',
                file_size: '10mb',
                onUploaded: function (up, file, result) {
                    $("input[name='eye_photo_right_origin']").val(file.name);
                    var res = JSON.parse(result.response);
                    $("input[name='eye_photo_right']").val(res.result.file);
                },
                isMulti: false
            });
        },

        methods: {
            /**
             * 检查输入的字符串是否合格
             */
            check: function () {
                if(ClearBr(vm.content) == '') {
                    return false;
                }
                vm.params['type'] = 1;
                vm.params['content'] = vm.content;
                vm.params['create_time'] = Date.parse(new Date()) / 1000;
                vm.pushMessage(1, vm.content);
                vm.content = '';
                vm.to_send = true;
                return true;
            },
            /**
             *  显示发送信息
             */
            pushMessage: function (type, content) {
                if(content == ''){
                    return false;
                }
                vm.chat.push({'source_user_id': '{$account.id}', 'target_user_id': '{$target_user_id}', 'type': type, 'content': content, 'create_time': Date.parse(new Date()) / 1000, 'status': 0});
                return true;
            },

            getReadIds: function () {
                vm.readIds = [];
                for(var i=0; i<vm.chat.length;i++){
                    if(vm.chat[i]['status'] == 0){
                        vm.readIds.push(vm.chat[i]['id']);
                    }
                }
                return vm.readIds.join(',');
            },
            enter:function(ev){
                if(ev.keyCode == 13 && vm.check()){
                    vm.send();
                }
                if(ev.keyCode == 13 && ! vm.check()){
                    vm.content = '';
                    ev.returnValue = false;
                }
            },

            markRead: function () {
                $.post("__PRO_PATH__/Chat/markRead", {ids: vm.getReadIds()}, function (res) {
                    if(res.error_code == 0){
                    } else{
                        console.log(res.msg);
                    }
                });
            },

            receiveMsg: function (data) {
                for(var i=0; i<data.length; i++){
                    if($.inArray(data[i]['id'], vm.receiveIds) == -1){
                        vm.readIds.push(data[i]['id']);
                        vm.chat.push(data[i]);
                    }
                }
                vm.markRead();
            },

            /**
             * 发送信息
             */
            send: function () {
                console.log(vm.params);
                $.post("__PRO_PATH__/Chat/send", vm.params, function (res) {
                    if(res.error_code == 0){
                        vm.to_send = false;
                        $('#chatScroll').slimScroll({
                            height:'300px',
                            start: 'bottom'
                        });
                    } else{
                        // 报错
                    }
                });
            }
        }
    });

    /**
     * 接收信息
     */
    function update(){
        $.post("__PRO_PATH__/Chat/receive", vm.receive_params, function (res) {
            if(res.error_code == 0){
                vm.receiveMsg(res.data);
            } else{
                console.log(res.msg);
            }
        });
    }

    update();
</script>
{else /}
<div class="main-container">
    <div class="padding-md">
        <span class="col-lg-12" style="font-size: larger; text-align: center">
			<strong>抱歉，您访问的页面不存在！</strong>
		</span>
    </div>
</div>
{include file="Common/bottom" /}
{/if}
